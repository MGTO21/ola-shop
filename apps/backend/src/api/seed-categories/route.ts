import { MedusaRequest, MedusaResponse } from "@medusajs/framework";
import { Modules } from "@medusajs/framework/utils";
import { IProductModuleService } from "@medusajs/framework/types";

export const AUTHENTICATE = false;

export const GET = async (req: MedusaRequest, res: MedusaResponse) => {
    const productService: IProductModuleService = req.scope.resolve(Modules.PRODUCT);

    const CATEGORY_TREE = [
        {
            name: "Makeup",
            name_ar: "??????????",
            handle: "makeup",
            children: [
                {
                    name: "Face",
                    name_ar: "??????????",
                    handle: "makeup-face",
                    children: [
                        { name: "Foundation", name_ar: "???????? ????????", handle: "makeup-face-foundation" },
                        { name: "Concealer", name_ar: "?????????????? / ????????", handle: "makeup-face-concealer" },
                        { name: "Compact & Loose Powder", name_ar: "?????????? ??????", handle: "makeup-face-powder" },
                        { name: "Primer", name_ar: "????????????", handle: "makeup-face-primer" },
                        { name: "Setting & Fixing Spray", name_ar: "???????? ??????????", handle: "makeup-face-setting-spray" },
                        { name: "BB & CC Cream", name_ar: "???????????? BB ?? CC", handle: "makeup-face-bb-cc" },
                        { name: "Blush", name_ar: "?????????? / ???????? ????????", handle: "makeup-face-blush" },
                        { name: "Highlighter", name_ar: "?????????? / ????????????????", handle: "makeup-face-highlighter" },
                        { name: "Contour", name_ar: "????????????", handle: "makeup-face-contour" },
                        { name: "Bronzer", name_ar: "??????????", handle: "makeup-face-bronzer" },
                        { name: "Face Palette", name_ar: "?????????? ??????", handle: "makeup-face-palette" },
                        { name: "Face Kit", name_ar: "?????? ??????", handle: "makeup-face-kit" }
                    ]
                },
                {
                    name: "Eyes",
                    name_ar: "????????????",
                    handle: "makeup-eyes",
                    children: [
                        { name: "Mascara", name_ar: "??????????", handle: "makeup-eyes-mascara" },
                        { name: "Eyeliner", name_ar: "?????? / ??????????????", handle: "makeup-eyes-eyeliner" },
                        { name: "Eyeshadow", name_ar: "???????? ????????????", handle: "makeup-eyes-eyeshadow" },
                        { name: "Eyebrow (Pencils/Gels)", name_ar: "??????????", handle: "makeup-eyes-eyebrow" },
                        { name: "Kohl Kajal", name_ar: "?????? ??????????", handle: "makeup-eyes-kohl" },
                        { name: "Eyelashes", name_ar: "????????", handle: "makeup-eyes-eyelashes" },
                        { name: "Eyelashes Care", name_ar: "?????????? ??????????????", handle: "makeup-eyes-eyelashes-care" },
                        { name: "Eye Mask", name_ar: "???????? ??????????", handle: "makeup-eyes-mask" },
                        { name: "Eye Set", name_ar: "???????????? ????????????", handle: "makeup-eyes-set" }
                    ]
                },
                {
                    name: "Lips",
                    name_ar: "????????????",
                    handle: "makeup-lips",
                    children: [
                        { name: "Lipstick", name_ar: "?????? / ???????? ????????", handle: "makeup-lips-lipstick" },
                        { name: "Liquid Lipstick", name_ar: "?????? ????????", handle: "makeup-lips-liquid-lipstick" },
                        { name: "Lip Gloss", name_ar: "???????? ????????", handle: "makeup-lips-gloss" },
                        { name: "Lip Liner", name_ar: "???????? ????????", handle: "makeup-lips-liner" },
                        { name: "Lip Tint", name_ar: "?????? ????????", handle: "makeup-lips-tint" },
                        { name: "Lip Balm", name_ar: "???????? ????????", handle: "makeup-lips-balm" },
                        { name: "Lip Oil", name_ar: "?????? ????????", handle: "makeup-lips-oil" },
                        { name: "Lip Plumper", name_ar: "???????? ????????", handle: "makeup-lips-plumper" },
                        { name: "Lip Kit", name_ar: "?????? ????????", handle: "makeup-lips-kit" },
                        { name: "Lip Set", name_ar: "???????????? ????????", handle: "makeup-lips-set" },
                        { name: "Lip Care", name_ar: "?????????? ??????????????", handle: "makeup-lips-care" }
                    ]
                },
                {
                    name: "Tools & More",
                    name_ar: "?????????? ??????????",
                    handle: "makeup-tools-more",
                    children: [
                        { name: "Makeup Tools", name_ar: "?????????? ??????????", handle: "makeup-tools" },
                        { name: "Makeup Remover", name_ar: "???????? ??????????", handle: "makeup-remover" },
                        { name: "Makeup Set", name_ar: "?????? ??????????", handle: "makeup-set" }
                    ]
                }
            ]
        },
        {
            name: "Perfumes",
            name_ar: "????????",
            handle: "perfumes",
            children: [
                {
                    name: "Type",
                    name_ar: "??????????",
                    handle: "perfumes-type",
                    children: [
                        { name: "Perfume", name_ar: "???????? ????????????", handle: "perfumes-type-perfume" },
                        { name: "Men Perfume", name_ar: "???????? ????????????", handle: "perfumes-type-men" },
                        { name: "Perfume Set", name_ar: "???????? ????????", handle: "perfumes-type-set" }
                    ]
                },
                {
                    name: "Oriental & Specialty",
                    name_ar: "???????????? ????????",
                    handle: "perfumes-oriental",
                    children: [
                        { name: "Body Musk", name_ar: "?????? ??????????", handle: "perfumes-oriental-body-musk" },
                        { name: "Musk Oil", name_ar: "???????? ??????", handle: "perfumes-oriental-musk-oil" },
                        { name: "Musk Cubes", name_ar: "???????????? ??????", handle: "perfumes-oriental-musk-cubes" },
                        { name: "Mabkhara", name_ar: "??????????", handle: "perfumes-oriental-mabkhara" }
                    ]
                },
                {
                    name: "Home",
                    name_ar: "????????????",
                    handle: "perfumes-home",
                    children: [
                        { name: "Air Freshener", name_ar: "???????????? ????", handle: "perfumes-home-freshener" },
                        { name: "Candles", name_ar: "????????", handle: "perfumes-home-candles" }
                    ]
                }
            ]
        },
        {
            name: "Skin Care",
            name_ar: "?????????? ??????????????",
            handle: "skincare",
            children: [
                {
                    name: "Face Care",
                    name_ar: "?????????? ????????????",
                    handle: "skincare-face",
                    children: [
                        { name: "Cleanser", name_ar: "????????", handle: "skincare-face-cleanser" },
                        { name: "Facial Wash", name_ar: "???????? ??????", handle: "skincare-face-wash" },
                        { name: "Toner", name_ar: "????????", handle: "skincare-face-toner" },
                        { name: "Face Serum", name_ar: "?????????? ??????", handle: "skincare-face-serum" },
                        { name: "Face Mask", name_ar: "???????? ??????", handle: "skincare-face-mask" },
                        { name: "Face Moisturizer", name_ar: "???????? ??????", handle: "skincare-face-moisturizer" },
                        { name: "Face Scrub", name_ar: "???????? ??????", handle: "skincare-face-scrub" },
                        { name: "Eye Care", name_ar: "?????????? ????????????", handle: "skincare-face-eye" },
                        { name: "Sunblock", name_ar: "???????? ??????", handle: "skincare-face-sunblock" },
                        { name: "Acne Care", name_ar: "?????????? ?????? ????????????", handle: "skincare-face-acne" },
                        { name: "Anti-Aging", name_ar: "???????????? ????????????????", handle: "skincare-face-anti-aging" }
                    ]
                },
                {
                    name: "Body Care",
                    name_ar: "?????????? ????????????",
                    handle: "skincare-body",
                    children: [
                        { name: "Body Mist", name_ar: "???????? ??????", handle: "skincare-body-mist" },
                        { name: "Body Lotion", name_ar: "???????? ??????", handle: "skincare-body-lotion" },
                        { name: "Body Cream", name_ar: "???????? ??????", handle: "skincare-body-cream" },
                        { name: "Body Butter", name_ar: "???????? ??????", handle: "skincare-body-butter" },
                        { name: "Body Oil", name_ar: "?????? ??????", handle: "skincare-body-oil" },
                        { name: "Body Scrub", name_ar: "???????? ??????", handle: "skincare-body-scrub" },
                        { name: "Body Powder", name_ar: "?????????? ??????", handle: "skincare-body-powder" },
                        { name: "Body Shimmer", name_ar: "???????? ??????", handle: "skincare-body-shimmer" },
                        { name: "Shower Gel", name_ar: "???? ??????????????", handle: "skincare-body-shower-gel" },
                        { name: "Deodorant", name_ar: "???????? ??????", handle: "skincare-body-deodorant" },
                        { name: "Deodorant Spray", name_ar: "???????? ???????? ??????", handle: "skincare-body-deodorant-spray" },
                        { name: "Private Area Care", name_ar: "?????????? ?????????????? ????????????", handle: "skincare-body-private" },
                        { name: "Hand Care", name_ar: "?????????? ??????????????", handle: "skincare-body-hand" },
                        { name: "Foot Care", name_ar: "?????????? ????????????????", handle: "skincare-body-foot" },
                        { name: "Massage Gel", name_ar: "???? ????????", handle: "skincare-body-massage" }
                    ]
                },
                {
                    name: "Kits & Tools",
                    name_ar: "???????? ????????????",
                    handle: "skincare-tools",
                    children: [
                        { name: "Skin Care Set", name_ar: "???????????? ??????????", handle: "skincare-tools-set" },
                        { name: "Skin Serum", name_ar: "?????????? ????????", handle: "skincare-tools-serum" },
                        { name: "Skin Tools", name_ar: "?????????? ????????", handle: "skincare-tools-tools" },
                        { name: "Soap", name_ar: "??????????", handle: "skincare-tools-soap" },
                        { name: "Bath Bomb", name_ar: "???????? ??????????????", handle: "skincare-tools-bathbomb" }
                    ]
                }
            ]
        },
        {
            name: "Hair Care",
            name_ar: "?????????? ????????????",
            handle: "haircare",
            children: [
                {
                    name: "Treatments",
                    name_ar: "????????????",
                    handle: "haircare-treatments",
                    children: [
                        { name: "Shampoo", name_ar: "??????????", handle: "haircare-treatments-shampoo" },
                        { name: "Conditioner", name_ar: "????????", handle: "haircare-treatments-conditioner" },
                        { name: "Hair Mask", name_ar: "???????? ??????", handle: "haircare-treatments-mask" },
                        { name: "Hair Oil", name_ar: "?????? ??????", handle: "haircare-treatments-oil" },
                        { name: "Hair Serum", name_ar: "?????????? ??????", handle: "haircare-treatments-serum" },
                        { name: "Hair Treatment", name_ar: "???????? ??????", handle: "haircare-treatments-treatment" }
                    ]
                },
                {
                    name: "Styling & Tools",
                    name_ar: "?????????? ????????????",
                    handle: "haircare-styling",
                    children: [
                        { name: "Hair Styling", name_ar: "???????????? ??????????", handle: "haircare-styling-products" },
                        { name: "Hair Perfume", name_ar: "?????? ??????", handle: "haircare-styling-perfume" },
                        { name: "Hair Tools", name_ar: "?????????? ??????", handle: "haircare-styling-tools" },
                        { name: "Hair Dryers & Stylers", name_ar: "???????????? ??????????????", handle: "haircare-styling-dryers" }
                    ]
                },
                {
                    name: "Kids",
                    name_ar: "??????????",
                    handle: "haircare-kids",
                    children: [
                        { name: "Kids Hair Care", name_ar: "?????????? ???????? ??????????????", handle: "haircare-kids-hair" },
                        { name: "Kids Body Care", name_ar: "?????????? ???????? ??????????????", handle: "haircare-kids-body" }
                    ]
                }
            ]
        },
        {
            name: "Nails",
            name_ar: "??????????",
            handle: "nails",
            children: [
                {
                    name: "Products",
                    name_ar: "????????????",
                    handle: "nails-products",
                    children: [
                        { name: "Nail Polish", name_ar: "???????????? / ???????? ??????????", handle: "nails-products-polish" },
                        { name: "Press On Nails", name_ar: "?????????? ??????????", handle: "nails-products-press-on" }
                    ]
                },
                {
                    name: "Care",
                    name_ar: "??????????",
                    handle: "nails-care",
                    children: [
                        { name: "Nail Care", name_ar: "?????????? ????????????????", handle: "nails-care-general" },
                        { name: "Nail Polish Remover", name_ar: "???????? ????????????", handle: "nails-care-remover" }
                    ]
                }
            ]
        },
        {
            name: "Accessories & Others",
            name_ar: "?????????????????? ??????????",
            handle: "accessories-others",
            children: [
                { name: "Bags", name_ar: "??????????", handle: "accessories-others-bags" },
                { name: "Supplements", name_ar: "????????????", handle: "accessories-others-supplements" }
            ]
        },
        {
            name: "Fashion",
            name_ar: "?????????? / ????????",
            handle: "fashion",
            children: [
                {
                    name: "Women",
                    name_ar: "????????",
                    handle: "fashion-women",
                    children: [
                        { name: "Dresses", name_ar: "????????????", handle: "fashion-women-dresses" },
                        { name: "Abayas", name_ar: "????????????", handle: "fashion-women-abayas" },
                        { name: "Shoes", name_ar: "??????????", handle: "fashion-women-shoes" },
                        { name: "Bags", name_ar: "??????????", handle: "fashion-women-bags" }
                    ]
                },
                {
                    name: "Men",
                    name_ar: "????????",
                    handle: "fashion-men",
                    children: [
                        { name: "Clothing", name_ar: "??????????", handle: "fashion-men-clothing" },
                        { name: "Shoes", name_ar: "??????????", handle: "fashion-men-shoes" },
                        { name: "Accessories", name_ar: "??????????????????", handle: "fashion-men-accessories" }
                    ]
                }
            ]
        },
        {
            name: "Sudanese Products",
            name_ar: "???????????????? ??????????????????",
            handle: "sudanese-products",
            children: [
                {
                    name: "Traditional",
                    name_ar: "????????????",
                    handle: "sudanese-traditional",
                    children: [
                        { name: "Thob", name_ar: "????????", handle: "sudanese-traditional-thob" },
                        { name: "Jalabiya", name_ar: "????????????", handle: "sudanese-traditional-jalabiya" }
                    ]
                },
                {
                    name: "Beauty",
                    name_ar: "????????",
                    handle: "sudanese-beauty",
                    children: [
                        { name: "Dilka", name_ar: "????????", handle: "sudanese-beauty-dilka" },
                        { name: "Dukhan", name_ar: "????????", handle: "sudanese-beauty-dukhan" },
                        { name: "Khumra", name_ar: "????????", handle: "sudanese-beauty-khumra" },
                        { name: "Mish", name_ar: "????", handle: "sudanese-beauty-mish" }
                    ]
                }
            ]
        }
    ];

    async function createCategory(node: any, parentId?: string, rank: number = 0) {
        let category = null;

        const existing = await productService.listProductCategories({ handle: node.handle }, { take: 1 });

        if (existing.length > 0) {
            console.log(`Updating category: ${node.name}`);
            // Only update if metadata needs it or parent changed
            category = await productService.updateProductCategories(existing[0].id, {
                name: node.name,
                rank: rank,
                parent_category_id: parentId || null,
                metadata: {
                    name_ar: node.name_ar
                }
            });
            console.log(`Updated: ${category.id}`);
        } else {
            console.log(`Creating category: ${node.name}`);
            category = await productService.createProductCategories({
                name: node.name,
                handle: node.handle,
                rank: rank,
                parent_category_id: parentId || null,
                metadata: {
                    name_ar: node.name_ar
                }
            });
            console.log(`Created: ${category.id}`);
        }

        if (node.children && node.children.length > 0) {
            for (let i = 0; i < node.children.length; i++) {
                await createCategory(node.children[i], category.id, i);
            }
        }
    }

    try {
        for (let i = 0; i < CATEGORY_TREE.length; i++) {
            await createCategory(CATEGORY_TREE[i], undefined, i);
        }
        res.json({ message: "Seeding Completed" });
    } catch (e: any) {
        res.status(500).json({ error: e.message });
    }
}
